name: Build Release From Tag

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "VERSION=$TAG" >> $GITHUB_ENV
          

      - name: Read changelog file
        id: changelog
        run: |
          CHANGELOG_FILE="fastlane/metadata/android/en-US/changelogs/${{ env.VERSION_CODE }}.txt"
          
          if [ -f "$CHANGELOG_FILE" ]; then
            # Parse format: first line=version, rest=changes (comma or * separated)
            VERSION_NAME=$(head -n 1 "$CHANGELOG_FILE")
            CHANGES=$(tail -n +2 "$CHANGELOG_FILE" | sed 's/^[ *]//g' | sed ':a;N;$!ba;s/,\n/\n/g' | sed 's/^/â€¢ /' | sed 's/$/\n/')
          
            # Format as markdown
            FORMATTED="## $VERSION_NAME\n\n$CHANGES"
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$FORMATTED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_changelog=true" >> $GITHUB_OUTPUT
          else
            echo "has_changelog=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Decode keystore
        run: echo "${{ secrets.KEYSTORE_FILE_B64 }}" | base64 -d > my-release-key.jks

      - name: Export signing env
        run: |
          echo "KEYSTORE_FILE=$PWD/my-release-key.jks" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Rename APK
        run: |
          NAME="DragonLauncher-${{ env.VERSION }}.apk"
          mv app/build/outputs/apk/release/app-release.apk "$NAME"
          echo "APK=$NAME" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: ${{ env.VERSION }}
          body: ${{ steps.changelog.outputs.changelog }}
          files: ${{ env.APK }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
